{
	"variables": {
		"build":                  "{{timestamp}}",
		"os_version":             "Windows2016",
    	"pre":                    "SICFactory",
    	"image_type":             "Default",

		"azure_app_id": 		  "{{env `ARM_CLIENT_ID`}}",
    	"azure_client_secret": 	  "{{env `ARM_CLIENT_SECRET`}}",
    	"azure_tenant_id": 		  "{{env `ARM_TENANT_ID`}}",
		"azure_sub_id": 		  "{{env `ARM_SUBSCRIPTION_ID`}}",

		"name":                   "{{user `pre`}}-{{user `os_version`}}-{{user `image_type`}}-{{user `build`}}",
		"description":            "{{user `pre`}}-{{user `os_version`}}-{{user `image_type`}}-{{user `build`}} built from latest Market place image",
		"vm_size":        		  "Standard_DS3_v2",
		"resource_group_name": 	  "myResourceGroup",
		"os_type":                "Windows",
    	"image_publisher":        "MicrosoftWindowsServer",
    	"image_offer":            "WindowsServer",
    	"image_sku":              "2016-Datacenter"
  },
	"builders": [{
		"type": 								    "azure-arm",
    	"client_id": 							    "{{user `azure_app_id`}}",
    	"client_secret": 						    "{{user `azure_client_secret`}}",
    	"tenant_id": 							    "{{user `azure_tenant_id`}}",
		"subscription_id": 						    "{{user `azure_sub_id`}}",
		"build_resource_group_name": 			  	"{{user `resource_group_name`}}",
		"managed_image_resource_group_name":		"{{user `resource_group_name`}}",
		"managed_image_name": 					    "{{user `name`}}",
		"os_type": 								    "{{user `os_type`}}",
		"image_publisher": 						    "{{user `image_publisher`}}",
		"image_offer": 							    "{{user `image_offer`}}",
    "image_sku": 							        "{{user `image_sku`}}",
    
    "communicator":                       "winrm",
	"winrm_port":                         5986,
    "winrm_use_ssl":                      "true",
    "winrm_insecure":                     "true",
    "winrm_timeout":                      "5m",
    "winrm_username":                     "packer",

		"azure_tags": {
			"Name":                 			"{{ user `name` }}",
      		"Description":            			"{{ user `description` }}",
      		"OS_Version":             			"{{ user `os_version` }}",
      		"Base_AMI_Name":          			"{{ .artifact_id }}"
			},
	"vm_size": 								            "{{ user `vm_size` }}",
	"async_resourcegroup_delete":true
	}],
	"provisioners": [{
    "type": "powershell",
      "inline": [
        "  while ((Get-Service RdAgent).Status -ne 'Running') { Start-Sleep -s 5 }",
        "  while ((Get-Service WindowsAzureTelemetryService).Status -ne 'Running') { Start-Sleep -s 5 }",
        "  while ((Get-Service WindowsAzureGuestAgent).Status -ne 'Running') { Start-Sleep -s 5 }",

        "if( Test-Path $Env:SystemRoot\\windows\\system32\\Sysprep\\unattend.xml ){ rm $Env:SystemRoot\\windows\\system32\\Sysprep\\unattend.xml -Force}",
        "& $env:SystemRoot\\System32\\Sysprep\\Sysprep.exe /oobe /generalize /quiet /quit /mode:vm",
        "while($true) { $imageState = Get-ItemProperty HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Setup\\State | Select ImageState; Write-Output $imageState.ImageState; if($imageState.ImageState -ne 'IMAGE_STATE_GENERALIZE_RESEAL_TO_OOBE') { Start-Sleep -s 10 } else { break } }"
    ]
  }],
	"post-processors": [
		{
		  "type": "manifest",
		  "output": "manifest.json",
      "strip_path": true,
      "custom_data": {
        "Name":                             			"{{ user `name` }}",
        "artifatt":                        			 	"{{ .artifact_id }}",
        "OS_version":                       			"{{ user `os_version` }}",
        "type": 								        "azure-arm",
    	"client_id": 							        "{{user `azure_app_id`}}",
    	"tenant_id": 							        "{{user `azure_tenant_id`}}",
		"subscription_id": 							    "{{user `azure_sub_id`}}",
		"build_resource_group_name": 				  	"{{user `resource_group_name`}}",
		"managed_image_resource_group_name":			"{{user `resource_group_name`}}",
		"managed_image_name": 						    "{{user `name`}}",
		"os_type": 									    "{{user `os_type`}}",
		"image_publisher": 							    "{{user `image_publisher`}}",
		"image_offer": 								    "{{user `image_offer`}}",
        "image_sku": 							        "{{user `image_sku`}}"
      }
		  }
	  ]
 }
